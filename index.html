<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCxq5QQU-H-gjbzaDqveRZOh6-dI452wuI",
    authDomain: "website-market-2a947.firebaseapp.com",
    projectId: "website-market-2a947",
    storageBucket: "website-market-2a947.firebasestorage.app",
    messagingSenderId: "314261738277",
    appId: "1:314261738277:web:a50c116a423d63455300cc"
  };

  const appId = "mein-marktplatz";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const addItemForm = document.getElementById("addItemForm");
  const itemsContainer = document.getElementById("itemsContainer");
  const currentUserIdSpan = document.getElementById("currentUserId");
  const currentBalanceSpan = document.getElementById("currentBalance");
  const messageBar = document.getElementById("messageBar");

  let userId;
  let userBalance = 0;
  let isAdmin = false; // <-- Admin Modus

  function showMessage(msg, type = 'success') {
    messageBar.textContent = msg;
    messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-100 opacity-100 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
    setTimeout(() => {
      messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0`;
    }, 3000);
  }

  async function authenticate() {
    try {
      await signInAnonymously(auth);
      userId = auth.currentUser.uid;
      currentUserIdSpan.textContent = userId;
      listenForUserBalance();
      listenForItems();
    } catch (error) {
      showMessage("Fehler bei der Anmeldung: " + error.message, 'error');
    }
  }

  const listenForUserBalance = () => {
    const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
    onSnapshot(userDocRef, (docSnap) => {
      if (docSnap.exists()) {
        userBalance = docSnap.data().balance;
      } else {
        userBalance = 1000;
        setDoc(userDocRef, { balance: userBalance });
      }
      currentBalanceSpan.textContent = userBalance.toFixed(2);
    });
  };

  const listenForItems = () => {
    const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
    onSnapshot(itemsCollectionRef, (querySnapshot) => {
      itemsContainer.innerHTML = '';
      querySnapshot.forEach((docSnap) => {
        const item = { id: docSnap.id, ...docSnap.data() };
        renderItem(item);
      });
    });
  };

  const renderItem = (item) => {
    const card = document.createElement("div");
    card.className = "bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow relative";
    card.innerHTML = `
      <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-full h-48 object-cover rounded-md mb-4">
      <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
      <p class="text-green-600 text-lg font-semibold">${item.price.toFixed(2)} €</p>
      <p class="text-sm text-gray-600 mb-2 truncate">${item.description}</p>
      <p class="text-xs text-gray-400">Verkäufer: ${item.sellerId}</p>
      <p class="text-xs text-gray-500">Menge: ${item.quantity}</p>
    `;

    // Admin darf alles löschen
    if (item.sellerId === userId || isAdmin) {
      const deleteButton = document.createElement("button");
      deleteButton.className = "absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition-colors";
      deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.728-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 112 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
      </svg>`;
      deleteButton.title = "Anzeige löschen";
      deleteButton.addEventListener("click", (e) => {
        e.stopPropagation();
        if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
          deleteItem(item.id);
        }
      });
      card.appendChild(deleteButton);
    }

    card.addEventListener("click", () => showItemDetails(item));
    itemsContainer.appendChild(card);
  };

  function showItemDetails(item) {
    const modal = document.createElement("div");
    modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50";

    const imagesHtml = item.imageUrls.map(url => `<img src="${url}" alt="${item.name}">`).join('');

    modal.innerHTML = `
      <div class="bg-white p-6 rounded-xl max-w-lg w-full relative">
        <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
        <div class="image-carousel mb-4">${imagesHtml}</div>
        <h2 class="text-2xl font-bold mb-2">${item.name}</h2>
        <p class="text-green-600 text-lg font-semibold mb-2">${item.price.toFixed(2)} €</p>
        <p class="mb-4">${item.description}</p>
        <p class="text-sm text-gray-500 mb-4">Verkäufer: ${item.sellerId}</p>
        <p class="text-sm text-gray-500 mb-6">Verfügbar: ${item.quantity} Stück</p>
        <button id="buyItemBtn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Kaufen</button>
        ${(item.sellerId === userId || isAdmin) ? `<button id="deleteItemBtn" class="w-full mt-2 px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Löschen</button>` : ''}
      </div>
    `;

    document.body.appendChild(modal);

    modal.querySelector("#closeModal").addEventListener("click", () => modal.remove());

    modal.querySelector("#buyItemBtn").addEventListener("click", async () => {
      await buyItem(item);
      modal.remove();
    });

    if (item.sellerId === userId || isAdmin) {
      modal.querySelector("#deleteItemBtn").addEventListener("click", () => {
        if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
          deleteItem(item.id);
          modal.remove();
        }
      });
    }
  }

  async function deleteItem(itemId) {
    try {
      const itemRef = doc(db, `artifacts/${appId}/public/data/products/${itemId}`);
      await deleteDoc(itemRef);
      showMessage("Artikel erfolgreich gelöscht!", 'success');
    } catch (err) {
      console.error(err);
      showMessage("Fehler beim Löschen des Artikels.", 'error');
    }
  }

  async function buyItem(item) {
    if (item.price > userBalance) {
      showMessage("Nicht genug Guthaben!", 'error');
      return;
    }
    if (item.quantity <= 0) {
      showMessage("Artikel nicht mehr verfügbar!", 'error');
      return;
    }

    try {
      const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
      await updateDoc(itemRef, { quantity: item.quantity - 1 });

      const buyerDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
      await updateDoc(buyerDocRef, { balance: userBalance - item.price });

      const sellerBalanceRef = doc(db, `artifacts/${appId}/users/${item.sellerId}/profile/balance`);
      const sellerSnap = await getDoc(sellerBalanceRef);
      if (sellerSnap.exists()) {
        await updateDoc(sellerBalanceRef, { balance: sellerSnap.data().balance + item.price });
      } else {
        await setDoc(sellerBalanceRef, { balance: item.price });
      }

      showMessage("Kauf erfolgreich!", 'success');
    } catch (err) {
      console.error(err);
      showMessage("Fehler beim Kauf.", 'error');
    }
  }

  addItemForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("itemName").value;

    // Check für Admin-Code
    if (name === "ADMIN_J123") {
      isAdmin = true;
      showMessage("Admin-Modus aktiviert!", 'success');
      addItemForm.reset();
      return;
    }

    const price = parseFloat(document.getElementById("itemPrice").value);
    const quantity = parseInt(document.getElementById("itemQuantity").value);
    const imageUrls = document.getElementById("itemImages").value.split(",").map(url => url.trim());
    const description = document.getElementById("itemDescription").value;

    const item = {
      name,
      price,
      quantity,
      imageUrls,
      description,
      sellerId: userId,
      timestamp: Date.now()
    };

    try {
      const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
      await addDoc(itemsCollectionRef, item);
      addItemForm.reset();
      showMessage("Artikel erfolgreich gepostet!", 'success');
    } catch (err) {
      console.error(err);
      showMessage("Fehler beim Posten des Artikels.", 'error');
    }
  });

  authenticate();
</script>
