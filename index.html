
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mein Online-Marktplatz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .container {
      max-width: 1200px;
    }
    .clickable-card {
      cursor: pointer;
    }
    .image-carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 8px;
    }
    .image-carousel img {
      flex: 0 0 auto;
      width: 100%;
      max-width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      scroll-snap-align: start;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <div id="messageBar" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0"></div>

  <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-2">Mein Online-Marktplatz</h1>
    <p class="text-center text-gray-500 mb-6 md:text-lg">Biete Artikel an und finde tolle Angebote!</p>

    <div id="userInfo" class="flex flex-col md:flex-row justify-center items-center gap-4 text-sm text-gray-600 mb-6 p-4 bg-gray-200 rounded-lg">
      <div>
        <p>Deine Nutzer-ID: <span id="currentUserId" class="font-mono font-bold text-blue-700"></span></p>
        <p>Dein Nutzername: <span id="currentUsername" class="font-bold text-purple-700">Nicht festgelegt</span></p>
        <p>Dein Guthaben: <span id="currentBalance" class="font-bold text-green-600"></span> €</p>
        <p id="adminStatus" class="text-red-600 font-bold hidden">[ADMIN-MODUS]</p>
      </div>
      <div class="flex items-center gap-2">
        <input type="text" id="usernameInput" placeholder="Nutzernamen festlegen" class="p-2 rounded border border-gray-300">
        <button id="saveUsernameBtn" class="p-2 bg-blue-500 text-white font-bold rounded hover:bg-blue-600">Speichern</button>
      </div>
    </div>

    <div id="adminBalanceControl" class="hidden mt-4 p-4 bg-yellow-50 rounded-lg shadow-inner">
      <h3 class="text-lg font-bold mb-2 text-gray-700">Guthaben eines Nutzers ändern</h3>
      <input type="text" id="targetUserId" placeholder="Nutzer-ID" class="w-full p-2 mb-2 rounded border border-gray-300">
      <input type="number" id="newBalance" placeholder="Neues Guthaben (€)" step="0.01" class="w-full p-2 mb-2 rounded border border-gray-300">
      <button id="updateBalanceBtn" class="w-full p-2 bg-green-500 text-white font-bold rounded hover:bg-green-600">Guthaben ändern</button>
    </div>

    <button id="myTransactionsBtn" class="mt-4 p-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition">Meine Transaktionen</button>

    <form id="addItemForm" class="bg-blue-50 p-6 rounded-xl shadow-inner mb-8 mt-4">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">Artikel anbieten</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="itemName" placeholder="Artikelbezeichnung" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
        <input type="number" id="itemPrice" placeholder="Preis in € (z.B. 9.99)" step="0.01" min="0" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      </div>
      <input type="number" id="itemQuantity" placeholder="Menge" min="1" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      <textarea id="itemImages" placeholder="Bild-URLs (durch Komma getrennt)" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <textarea id="itemDescription" placeholder="Artikelbeschreibung" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <button type="submit" class="w-full mt-6 p-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">Artikel posten</button>
    </form>

    <h2 class="text-3xl font-bold text-gray-700 mt-8 mb-4 text-center">Aktuelle Angebote</h2>
    <div id="itemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyCxq5QQU-H-gjbzaDqveRZOh6-dI452wuI",
      authDomain: "website-market-2a947.firebaseapp.com",
      projectId: "website-market-2a947",
      storageBucket: "website-market-2a947.firebasestorage.app",
      messagingSenderId: "314261738277",
      appId: "1:314261738277:web:a50c116a423d63455300cc"
    };

    const appId = "mein-marktplatz";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM Elements
    const elements = {
        addItemForm: document.getElementById("addItemForm"),
        itemsContainer: document.getElementById("itemsContainer"),
        currentUserIdSpan: document.getElementById("currentUserId"),
        currentUsernameSpan: document.getElementById("currentUsername"),
        currentBalanceSpan: document.getElementById("currentBalance"),
        messageBar: document.getElementById("messageBar"),
        adminStatus: document.getElementById("adminStatus"),
        adminBalanceControl: document.getElementById("adminBalanceControl"),
        updateBalanceBtn: document.getElementById("updateBalanceBtn"),
        myTransactionsBtn: document.getElementById("myTransactionsBtn"),
        saveUsernameBtn: document.getElementById("saveUsernameBtn"),
        usernameInput: document.getElementById("usernameInput")
    };

    let userId;
    let userBalance = 0;
    let isAdmin = false;
    const userCache = {}; // Cache for usernames

    function showMessage(msg, type = 'success') {
      elements.messageBar.textContent = msg;
      elements.messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-100 opacity-100 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      setTimeout(() => {
        elements.messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0`;
      }, 3000);
    }

    function toggleAdminMode(enable) {
      isAdmin = enable;
      elements.adminStatus.classList.toggle("hidden", !isAdmin);
      elements.adminBalanceControl.classList.toggle("hidden", !isAdmin);
      showMessage(isAdmin ? "Admin-Modus aktiviert!" : "Admin-Modus deaktiviert!", isAdmin ? 'success' : 'error');
    }

    async function authenticate() {
      try {
        await signInAnonymously(auth);
        userId = auth.currentUser.uid;
        elements.currentUserIdSpan.textContent = userId;
        listenForUserProfile();
        listenForItems();
      } catch (error) {
        showMessage("Fehler bei der Anmeldung: " + error.message, 'error');
      }
    }

    const listenForUserProfile = () => {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
      onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          const data = docSnap.data();
          userBalance = data.balance !== undefined ? data.balance : 1000;
          elements.currentUsernameSpan.textContent = data.username || "Nicht festgelegt";
          if(data.username) userCache[userId] = data.username;
        } else {
          userBalance = 1000;
          setDoc(userDocRef, { balance: userBalance, username: null });
        }
        elements.currentBalanceSpan.textContent = userBalance.toFixed(2);
      });
    };

    const listenForItems = () => {
      const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
      onSnapshot(itemsCollectionRef, (querySnapshot) => {
        elements.itemsContainer.innerHTML = '';
        querySnapshot.forEach((docSnap) => {
          const item = { id: docSnap.id, ...docSnap.data() };
          if (item.quantity > 0) { // Only render items that are in stock
             renderItem(item);
          }
        });
      });
    };

    async function getUsername(id) {
        if (userCache[id]) return userCache[id];
        if (!id) return "Unbekannt";
        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${id}/profile/data`);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists() && docSnap.data().username) {
                userCache[id] = docSnap.data().username;
                return docSnap.data().username;
            }
        } catch (error) {
            console.error("Fehler beim Abrufen des Nutzernamens:", error);
        }
        return id; // Fallback to ID
    }

    const renderItem = async (item) => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow relative";
      const sellerName = await getUsername(item.sellerId);
      
      card.innerHTML = `
        <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-full h-48 object-cover rounded-md mb-4">
        <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
        <p class="text-green-600 text-lg font-semibold">${item.price.toFixed(2)} €</p>
        <p class="text-sm text-gray-600 mb-2 truncate">${item.description}</p>
        <p class="text-xs text-gray-400">Verkäufer: <span class="font-bold">${sellerName}</span></p>
        <p class="text-xs text-gray-500">Menge: ${item.quantity}</p>
      `;

      if (item.sellerId === userId || isAdmin) {
        // ... (delete and edit buttons remain the same)
        const deleteButton = document.createElement("button");
        deleteButton.className = "absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition-colors";
        deleteButton.innerHTML = `✖`;
        deleteButton.title = "Anzeige löschen";
        deleteButton.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
            deleteItem(item.id);
          }
        });

        const editButton = document.createElement("button");
        editButton.className = "absolute top-2 right-12 p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition-colors";
        editButton.innerHTML = "✏️";
        editButton.title = "Anzeige bearbeiten";
        editButton.addEventListener("click", (e) => {
          e.stopPropagation();
          editItem(item);
        });

        card.appendChild(deleteButton);
        card.appendChild(editButton);
      }

      card.addEventListener("click", () => showItemDetails(item));
      elements.itemsContainer.appendChild(card);
    };

    async function showItemDetails(item) {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50";

        const sellerName = await getUsername(item.sellerId);
        const imagesHtml = item.imageUrls.map(url => `<img src="${url}" alt="${item.name}" class="mb-2 w-full h-48 object-cover rounded">`).join('');

        modal.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-lg w-full relative">
          <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
          <div class="image-carousel mb-4">${imagesHtml}</div>
          <h2 class="text-2xl font-bold mb-2">${item.name}</h2>
          <p class="text-green-600 text-lg font-semibold mb-2">${item.price.toFixed(2)} €</p>
          <p class="mb-4">${item.description}</p>
          <p class="text-sm text-gray-500 mb-1">Verkäufer: <span class="font-bold">${sellerName}</span></p>
          <p class="text-sm text-gray-500 mb-4">Verfügbar: ${item.quantity} Stück</p>
          <div class="flex gap-2 items-center mb-4">
             <input type="number" id="buyQuantity" value="1" min="1" max="${item.quantity}" class="w-1/4 p-2 border rounded">
             <button id="buyItemBtn" class="w-3/4 px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Kaufen</button>
          </div>
          ${(item.sellerId === userId || isAdmin) ? `
            <button id="editItemBtn" class="w-full mt-2 px-4 py-3 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition">Bearbeiten</button>
            <button id="deleteItemBtn" class="w-full mt-2 px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Löschen</button>` : ''}
        </div>
      `;

        document.body.appendChild(modal);

        modal.querySelector("#closeModal").addEventListener("click", () => modal.remove());
        modal.querySelector("#buyItemBtn").addEventListener("click", async () => {
            const quantity = parseInt(modal.querySelector("#buyQuantity").value);
            if(quantity > 0) {
              await buyItem(item, quantity);
              modal.remove();
            } else {
              showMessage("Bitte eine gültige Menge angeben.", "error");
            }
        });

        if (item.sellerId === userId || isAdmin) {
            modal.querySelector("#deleteItemBtn").addEventListener("click", () => {
                if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
                    deleteItem(item.id);
                    modal.remove();
                }
            });
            modal.querySelector("#editItemBtn").addEventListener("click", () => {
                modal.remove();
                editItem(item);
            });
        }
    }

    async function editItem(item) {
        // ... (edit logic remains the same)
        const newName = prompt("Neuer Name:", item.name);
        if (newName === null) return;
        const newPrice = parseFloat(prompt("Neuer Preis:", item.price));
        if (isNaN(newPrice) || newPrice < 0) { showMessage("Ungültiger Preis!", "error"); return; }
        const newQuantity = parseInt(prompt("Neue Menge:", item.quantity));
        if (isNaN(newQuantity) || newQuantity < 0) { showMessage("Ungültige Menge!", "error"); return; }
        const newDesc = prompt("Neue Beschreibung:", item.description);
        if (newDesc === null) return;

        try {
            const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
            await updateDoc(itemRef, {
                name: newName,
                price: newPrice,
                quantity: newQuantity,
                description: newDesc
            });
            showMessage("Artikel erfolgreich bearbeitet!", 'success');
        } catch (err) {
            console.error(err);
            showMessage("Fehler beim Bearbeiten des Artikels.", 'error');
        }
    }

    async function deleteItem(itemId) {
        // ... (delete logic remains the same)
        try {
            const itemRef = doc(db, `artifacts/${appId}/public/data/products/${itemId}`);
            await deleteDoc(itemRef);
            showMessage("Artikel erfolgreich gelöscht!", 'success');
        } catch (err) {
            console.error(err);
            showMessage("Fehler beim Löschen des Artikels.", 'error');
        }
    }

    async function buyItem(item, quantity) {
        const totalPrice = item.price * quantity;
        if (totalPrice > userBalance) {
            showMessage("Nicht genug Guthaben!", 'error');
            return;
        }
        if (quantity > item.quantity) {
            showMessage("Nicht genügend Artikel auf Lager!", 'error');
            return;
        }

        const batch = writeBatch(db);

        // 1. Update item quantity
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
        batch.update(itemRef, { quantity: item.quantity - quantity });

        // 2. Debit buyer
        const buyerDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
        batch.update(buyerDocRef, { balance: userBalance - totalPrice });

        // 3. Credit seller
        const sellerDocRef = doc(db, `artifacts/${appId}/users/${item.sellerId}/profile/data`);
        const sellerSnap = await getDoc(sellerDocRef);
        if (sellerSnap.exists()) {
             batch.update(sellerDocRef, { balance: sellerSnap.data().balance + totalPrice });
        } else {
             batch.set(sellerDocRef, { balance: 1000 + totalPrice }); // Start seller with 1000 + earnings
        }

        // 4. Create transaction log
        const transactionRef = doc(collection(db, `artifacts/${appId}/public/data/transactions`));
        batch.set(transactionRef, {
            itemId: item.id,
            itemName: item.name,
            itemImage: item.imageUrls[0],
            pricePerUnit: item.price,
            quantityBought: quantity,
            totalPrice: totalPrice,
            sellerId: item.sellerId,
            buyerId: userId,
            timestamp: Date.now()
        });
        
        try {
            await batch.commit();
            showMessage(`Kauf von ${quantity} x ${item.name} erfolgreich!`, 'success');
        } catch (err) {
            console.error(err);
            showMessage("Fehler beim Kauf.", 'error');
        }
    }

    elements.addItemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("itemName").value;

      if (name === "ADMIN_J123") {
        toggleAdminMode(true);
        elements.addItemForm.reset();
        return;
      }
      if (name === "ADMIN_D123") {
        toggleAdminMode(false);
        elements.addItemForm.reset();
        return;
      }

      const price = parseFloat(document.getElementById("itemPrice").value);
      const quantity = parseInt(document.getElementById("itemQuantity").value);
      const imageUrls = document.getElementById("itemImages").value.split(",").map(url => url.trim());
      const description = document.getElementById("itemDescription").value;

      if (price < 0 || quantity < 0) {
        showMessage("Preis und Menge dürfen nicht negativ sein!", "error");
        return;
      }

      const item = { name, price, quantity, imageUrls, description, sellerId: userId, timestamp: Date.now() };

      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/products`), item);
        elements.addItemForm.reset();
        showMessage("Artikel erfolgreich hinzugefügt!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Hinzufügen des Artikels.", 'error');
      }
    });

    elements.saveUsernameBtn.addEventListener("click", async () => {
        const newUsername = elements.usernameInput.value.trim();
        if (newUsername.length < 3) {
            showMessage("Nutzername muss mindestens 3 Zeichen lang sein!", "error");
            return;
        }
        try {
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);
            await setDoc(userDocRef, { username: newUsername }, { merge: true });
            showMessage("Nutzername erfolgreich gespeichert!", "success");
            elements.usernameInput.value = "";
        } catch (err) {
            console.error(err);
            showMessage("Fehler beim Speichern des Nutzernamens.", "error");
        }
    });

    elements.updateBalanceBtn.addEventListener("click", async () => {
      // ... (admin balance logic remains the same)
      const targetId = document.getElementById("targetUserId").value.trim();
      const newBal = parseFloat(document.getElementById("newBalance").value);

      if (!targetId || isNaN(newBal) || newBal < 0) {
        showMessage("Bitte gültige Nutzer-ID und Guthaben eingeben!", "error");
        return;
      }

      try {
        const targetRef = doc(db, `artifacts/${appId}/users/${targetId}/profile/data`);
        await setDoc(targetRef, { balance: newBal }, { merge: true });
        showMessage(`Guthaben von Nutzer ${targetId} auf ${newBal.toFixed(2)} € gesetzt!`, "success");
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Ändern des Guthabens.", "error");
      }
    });

    elements.myTransactionsBtn.addEventListener("click", async () => {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start p-4 z-50 overflow-auto";

        modal.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-4xl w-full relative mt-10">
            <button id="closeTransactionsModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
            <h2 class="text-3xl font-bold mb-6 text-center">Meine Transaktionen</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-green-700">Verkäufe</h3>
                    <div id="soldItemsContainer" class="space-y-3"></div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-blue-700">Käufe</h3>
                    <div id="boughtItemsContainer" class="space-y-3"></div>
                </div>
            </div>
        </div>
        `;
        document.body.appendChild(modal);
        modal.querySelector("#closeTransactionsModal").addEventListener("click", () => modal.remove());
        
        const soldContainer = modal.querySelector("#soldItemsContainer");
        const boughtContainer = modal.querySelector("#boughtItemsContainer");
        soldContainer.innerHTML = "<p>Lade Verkäufe...</p>";
        boughtContainer.innerHTML = "<p>Lade Käufe...</p>";

        try {
            const transCol = collection(db, `artifacts/${appId}/public/data/transactions`);
            
            // Get Sales
            const salesQuery = query(transCol, where("sellerId", "==", userId));
            const salesSnapshot = await getDocs(salesQuery);
            soldContainer.innerHTML = "";
            if (salesSnapshot.empty) {
                soldContainer.innerHTML = "<p class='text-gray-500'>Keine Verkäufe gefunden.</p>";
            } else {
                for(const docSnap of salesSnapshot.docs) {
                    const t = docSnap.data();
                    const buyerName = await getUsername(t.buyerId);
                    soldContainer.innerHTML += `
                        <div class="p-3 border rounded-lg bg-green-50 flex gap-4 items-center">
                            <img src="${t.itemImage}" alt="${t.itemName}" class="w-16 h-16 object-cover rounded">
                            <div>
                                <strong>${t.quantityBought}x ${t.itemName}</strong><br>
                                Verkauft an: <span class="font-semibold">${buyerName}</span><br>
                                Gesamterlös: <span class="font-bold text-green-600">${t.totalPrice.toFixed(2)} €</span><br>
                                <span class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleString()}</span>
                            </div>
                        </div>`;
                }
            }

            // Get Purchases
            const purchasesQuery = query(transCol, where("buyerId", "==", userId));
            const purchasesSnapshot = await getDocs(purchasesQuery);
            boughtContainer.innerHTML = "";
             if (purchasesSnapshot.empty) {
                boughtContainer.innerHTML = "<p class='text-gray-500'>Keine Käufe gefunden.</p>";
            } else {
                for(const docSnap of purchasesSnapshot.docs) {
                    const t = docSnap.data();
                    const sellerName = await getUsername(t.sellerId);
                    boughtContainer.innerHTML += `
                        <div class="p-3 border rounded-lg bg-blue-50 flex gap-4 items-center">
                            <img src="${t.itemImage}" alt="${t.itemName}" class="w-16 h-16 object-cover rounded">
                            <div>
                                <strong>${t.quantityBought}x ${t.itemName}</strong><br>
                                Gekauft von: <span class="font-semibold">${sellerName}</span><br>
                                Gesamtkosten: <span class="font-bold text-red-600">${t.totalPrice.toFixed(2)} €</span><br>
                                <span class="text-xs text-gray-500">${new Date(t.timestamp).toLocaleString()}</span>
                            </div>
                        </div>`;
                }
            }
        } catch (err) {
            console.error(err);
            showMessage("Fehler beim Laden der Transaktionen.", "error");
        }
    });

    authenticate();
  </script>
</body>
</html>


  <!-- Nachrichtenleiste -->
  <div id="messageBar" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0"></div>

  <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-2">Mein Online-Marktplatz</h1>
    <p class="text-center text-gray-500 mb-6 md:text-lg">Biete Artikel an und finde tolle Angebote!</p>

    <div id="userInfo" class="flex flex-col md:flex-row justify-center items-center gap-4 text-sm text-gray-600 mb-6 p-2 bg-gray-200 rounded-lg">
      <p>Deine Nutzer-ID: <span id="currentUserId" class="font-mono font-bold text-blue-700"></span></p>
      <p>Dein Guthaben: <span id="currentBalance" class="font-bold text-green-600"></span> €</p>
      <p id="adminStatus" class="text-red-600 font-bold hidden">[ADMIN-MODUS]</p>
    </div>

    <!-- Admin-Guthabenkontrolle -->
    <div id="adminBalanceControl" class="hidden mt-4 p-4 bg-yellow-50 rounded-lg shadow-inner">
      <h3 class="text-lg font-bold mb-2 text-gray-700">Guthaben eines Nutzers ändern</h3>
      <input type="text" id="targetUserId" placeholder="Nutzer-ID" class="w-full p-2 mb-2 rounded border border-gray-300">
      <input type="number" id="newBalance" placeholder="Neues Guthaben (€)" step="0.01" class="w-full p-2 mb-2 rounded border border-gray-300">
      <button id="updateBalanceBtn" class="w-full p-2 bg-green-500 text-white font-bold rounded hover:bg-green-600">Guthaben ändern</button>
    </div>

    <button id="myTransactionsBtn" class="mt-4 p-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition">Meine Transaktionen</button>

    <form id="addItemForm" class="bg-blue-50 p-6 rounded-xl shadow-inner mb-8">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">Artikel anbieten</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="itemName" placeholder="Artikelbezeichnung" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
        <input type="number" id="itemPrice" placeholder="Preis in € (z.B. 9.99)" step="0.01" min="0" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      </div>
      <input type="number" id="itemQuantity" placeholder="Menge" min="0" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      <textarea id="itemImages" placeholder="Bild-URLs (durch Komma getrennt)" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <textarea id="itemDescription" placeholder="Artikelbeschreibung" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <button type="submit" class="w-full mt-6 p-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">Artikel posten</button>
    </form>

    <h2 class="text-3xl font-bold text-gray-700 mt-8 mb-4 text-center">Aktuelle Angebote</h2>
    <div id="itemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Artikel werden hier dynamisch eingefügt -->
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyCxq5QQU-H-gjbzaDqveRZOh6-dI452wuI",
      authDomain: "website-market-2a947.firebaseapp.com",
      projectId: "website-market-2a947",
      storageBucket: "website-market-2a947.firebasestorage.app",
      messagingSenderId: "314261738277",
      appId: "1:314261738277:web:a50c116a423d63455300cc"
    };

    const appId = "mein-marktplatz";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const addItemForm = document.getElementById("addItemForm");
    const itemsContainer = document.getElementById("itemsContainer");
    const currentUserIdSpan = document.getElementById("currentUserId");
    const currentBalanceSpan = document.getElementById("currentBalance");
    const messageBar = document.getElementById("messageBar");
    const adminStatus = document.getElementById("adminStatus");
    const adminBalanceControl = document.getElementById("adminBalanceControl");
    const updateBalanceBtn = document.getElementById("updateBalanceBtn");
    const myTransactionsBtn = document.getElementById("myTransactionsBtn");

    let userId;
    let userBalance = 0;
    let isAdmin = false;

    function showMessage(msg, type = 'success') {
      messageBar.textContent = msg;
      messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-100 opacity-100 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      setTimeout(() => {
        messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0`;
      }, 3000);
    }

    function toggleAdminMode(enable) {
      isAdmin = enable;
      adminStatus.classList.toggle("hidden", !isAdmin);
      adminBalanceControl.classList.toggle("hidden", !isAdmin);
      showMessage(isAdmin ? "Admin-Modus aktiviert!" : "Admin-Modus deaktiviert!", isAdmin ? 'success' : 'error');
    }

    async function authenticate() {
      try {
        await signInAnonymously(auth);
        userId = auth.currentUser.uid;
        currentUserIdSpan.textContent = userId;
        listenForUserBalance();
        listenForItems();
      } catch (error) {
        showMessage("Fehler bei der Anmeldung: " + error.message, 'error');
      }
    }

    const listenForUserBalance = () => {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
      onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          userBalance = docSnap.data().balance;
        } else {
          userBalance = 1000;
          setDoc(userDocRef, { balance: userBalance });
        }
        currentBalanceSpan.textContent = userBalance.toFixed(2);
      });
    };

    const listenForItems = () => {
      const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
      onSnapshot(itemsCollectionRef, (querySnapshot) => {
        itemsContainer.innerHTML = '';
        querySnapshot.forEach((docSnap) => {
          const item = { id: docSnap.id, ...docSnap.data() };
          renderItem(item);
        });
      });
    };

    const renderItem = (item) => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow relative";
      card.innerHTML = `
        <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-full h-48 object-cover rounded-md mb-4">
        <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
        <p class="text-green-600 text-lg font-semibold">${item.price.toFixed(2)} €</p>
        <p class="text-sm text-gray-600 mb-2 truncate">${item.description}</p>
        <p class="text-xs text-gray-400">Verkäufer: ${item.sellerId}</p>
        <p class="text-xs text-gray-500">Menge: ${item.quantity}</p>
      `;

      if (item.sellerId === userId || isAdmin) {
        const deleteButton = document.createElement("button");
        deleteButton.className = "absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition-colors";
        deleteButton.innerHTML = `✖`;
        deleteButton.title = "Anzeige löschen";
        deleteButton.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
            deleteItem(item.id);
          }
        });

        const editButton = document.createElement("button");
        editButton.className = "absolute top-2 right-12 p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition-colors";
        editButton.innerHTML = "✏️";
        editButton.title = "Anzeige bearbeiten";
        editButton.addEventListener("click", (e) => {
          e.stopPropagation();
          editItem(item);
        });

        card.appendChild(deleteButton);
        card.appendChild(editButton);
      }

      card.addEventListener("click", () => showItemDetails(item));
      itemsContainer.appendChild(card);
    };

    function showItemDetails(item) {
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50";

      const imagesHtml = item.imageUrls.map(url => `<img src="${url}" alt="${item.name}" class="mb-2 w-full h-48 object-cover rounded">`).join('');

      modal.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-lg w-full relative">
          <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
          <div class="image-carousel mb-4">${imagesHtml}</div>
          <h2 class="text-2xl font-bold mb-2">${item.name}</h2>
          <p class="text-green-600 text-lg font-semibold mb-2">${item.price.toFixed(2)} €</p>
          <p class="mb-4">${item.description}</p>
          <p class="text-sm text-gray-500 mb-4">Verkäufer: ${item.sellerId}</p>
          <p class="text-sm text-gray-500 mb-6">Verfügbar: ${item.quantity} Stück</p>
          <button id="buyItemBtn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Kaufen</button>
          ${(item.sellerId === userId || isAdmin) ? `
            <button id="editItemBtn" class="w-full mt-2 px-4 py-3 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition">Bearbeiten</button>
            <button id="deleteItemBtn" class="w-full mt-2 px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Löschen</button>` : ''}
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector("#closeModal").addEventListener("click", () => modal.remove());
      modal.querySelector("#buyItemBtn").addEventListener("click", async () => {
        await buyItem(item);
        modal.remove();
      });

      if (item.sellerId === userId || isAdmin) {
        modal.querySelector("#deleteItemBtn").addEventListener("click", () => {
          if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
            deleteItem(item.id);
            modal.remove();
          }
        });
        modal.querySelector("#editItemBtn").addEventListener("click", () => {
          modal.remove();
          editItem(item);
        });
      }
    }

    async function editItem(item) {
      const newName = prompt("Neuer Name:", item.name);
      if (newName === null) return;
      const newPrice = parseFloat(prompt("Neuer Preis:", item.price));
      if (isNaN(newPrice) || newPrice < 0) { showMessage("Ungültiger Preis!", "error"); return; }
      const newQuantity = parseInt(prompt("Neue Menge:", item.quantity));
      if (isNaN(newQuantity) || newQuantity < 0) { showMessage("Ungültige Menge!", "error"); return; }
      const newDesc = prompt("Neue Beschreibung:", item.description);
      if (newDesc === null) return;

      try {
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
        await updateDoc(itemRef, {
          name: newName,
          price: newPrice,
          quantity: newQuantity,
          description: newDesc
        });
        showMessage("Artikel erfolgreich bearbeitet!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Bearbeiten des Artikels.", 'error');
      }
    }

    async function deleteItem(itemId) {
      try {
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${itemId}`);
        await deleteDoc(itemRef);
        showMessage("Artikel erfolgreich gelöscht!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Löschen des Artikels.", 'error');
      }
    }

    async function buyItem(item) {
      if (item.price > userBalance) {
        showMessage("Nicht genug Guthaben!", 'error');
        return;
      }
      if (item.quantity <= 0) {
        showMessage("Artikel nicht mehr verfügbar!", 'error');
        return;
      }

      try {
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
        await updateDoc(itemRef, { 
          quantity: item.quantity - 1,
          soldTo: userId,
          buyerId: userId,
          soldAt: Date.now()
        });

        const buyerDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
        await updateDoc(buyerDocRef, { balance: userBalance - item.price });

        const sellerBalanceRef = doc(db, `artifacts/${appId}/users/${item.sellerId}/profile/balance`);
        const sellerSnap = await getDoc(sellerBalanceRef);
        if (sellerSnap.exists()) {
          await updateDoc(sellerBalanceRef, { balance: sellerSnap.data().balance + item.price });
        } else {
          await setDoc(sellerBalanceRef, { balance: item.price });
        }

        showMessage("Kauf erfolgreich!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Kauf.", 'error');
      }
    }

    addItemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("itemName").value;

      if (name === "ADMIN_J123") {
        toggleAdminMode(true);
        addItemForm.reset();
        return;
      }
      if (name === "ADMIN_D123") {
        toggleAdminMode(false);
        addItemForm.reset();
        return;
      }

      const price = parseFloat(document.getElementById("itemPrice").value);
      const quantity = parseInt(document.getElementById("itemQuantity").value);
      const imageUrls = document.getElementById("itemImages").value.split(",").map(url => url.trim());
      const description = document.getElementById("itemDescription").value;

      if (price < 0 || quantity < 0) {
        showMessage("Preis und Menge dürfen nicht negativ sein!", "error");
        return;
      }

      const item = {
        name,
        price,
        quantity,
        imageUrls,
        description,
        sellerId: userId,
        timestamp: Date.now()
      };

      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/products`), item);
        addItemForm.reset();
        showMessage("Artikel erfolgreich hinzugefügt!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Hinzufügen des Artikels.", 'error');
      }
    });

    // Admin: Guthaben ändern
    updateBalanceBtn.addEventListener("click", async () => {
      const targetId = document.getElementById("targetUserId").value.trim();
      const newBal = parseFloat(document.getElementById("newBalance").value);

      if (!targetId || isNaN(newBal) || newBal < 0) {
        showMessage("Bitte gültige Nutzer-ID und Guthaben eingeben!", "error");
        return;
      }

      try {
        const targetRef = doc(db, `artifacts/${appId}/users/${targetId}/profile/balance`);
        await setDoc(targetRef, { balance: newBal }, { merge: true });
        showMessage(`Guthaben von Nutzer ${targetId} auf ${newBal.toFixed(2)} € gesetzt!`, "success");
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Ändern des Guthabens.", "error");
      }
    });

    // Transaktionen anzeigen
    myTransactionsBtn.addEventListener("click", async () => {
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start p-4 z-50 overflow-auto";

      modal.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-3xl w-full relative mt-10">
          <button id="closeTransactionsModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
          <h2 class="text-2xl font-bold mb-4">Meine Transaktionen</h2>
          <div id="transactionsContent" class="grid gap-4"></div>
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector("#closeTransactionsModal").addEventListener("click", () => modal.remove());

      const transactionsContent = modal.querySelector("#transactionsContent");

      try {
        const productsCol = collection(db, `artifacts/${appId}/public/data/products`);
        const snapshot = await getDocs(productsCol);

        transactionsContent.innerHTML = "";

        snapshot.forEach(docSnap => {
          const item = { id: docSnap.id, ...docSnap.data() };

          // Verkauft
          if (item.sellerId === userId && item.soldTo) {
            const soldCard = document.createElement("div");
            soldCard.className = "p-3 border rounded bg-green-50 flex gap-4";
            soldCard.innerHTML = `
              <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
              <div>
                <strong>Verkauft:</strong> ${item.name} <br>
                Preis: ${item.price.toFixed(2)} € <br>
                An: ${item.soldTo} <br>
                Menge: ${item.quantity} <br>
                Datum: ${new Date(item.soldAt).toLocaleString()}
              </div>
            `;
            transactionsContent.appendChild(soldCard);
          }

          // Gekauft
          if (item.buyerId === userId) {
            const boughtCard = document.createElement("div");
            boughtCard.className = "p-3 border rounded bg-blue-50 flex gap-4";
            boughtCard.innerHTML = `
              <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
              <div>
                <strong>Gekauft:</strong> ${item.name} <br>
                Preis: ${item.price.toFixed(2)} € <br>
                Von: ${item.sellerId} <br>
                Menge: ${item.quantity} <br>
                Datum: ${new Date(item.soldAt).toLocaleString()}
              </div>
            `;
            transactionsContent.appendChild(boughtCard);
          }
        });

        if (transactionsContent.innerHTML === "") {
          transactionsContent.innerHTML = "<p class='text-gray-500'>Keine Transaktionen gefunden.</p>";
        }

      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Laden der Transaktionen.", "error");
      }
    });

    authenticate();
  </script>
</body>
</html>
