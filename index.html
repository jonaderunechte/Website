<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mein Online-Marktplatz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .container {
      max-width: 1200px;
    }
    .clickable-card {
      cursor: pointer;
    }
    .image-carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 8px;
    }
    .image-carousel img {
      flex: 0 0 auto;
      width: 100%;
      max-width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      scroll-snap-align: start;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-2">Mein Online-Marktplatz</h1>
    <p class="text-center text-gray-500 mb-6 md:text-lg">Biete Artikel an und finde tolle Angebote!</p>

    <div id="userInfo" class="flex flex-col md:flex-row justify-center items-center gap-4 text-sm text-gray-600 mb-6 p-2 bg-gray-200 rounded-lg">
      <p>Deine Nutzer-ID: <span id="currentUserId" class="font-mono font-bold text-blue-700"></span></p>
      <p>Dein Guthaben: <span id="currentBalance" class="font-bold text-green-600"></span> €</p>
    </div>

    <form id="addItemForm" class="bg-blue-50 p-6 rounded-xl shadow-inner mb-8">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">Artikel anbieten</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="itemName" placeholder="Artikelbezeichnung" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
        <input type="number" id="itemPrice" placeholder="Preis in € (z.B. 9.99)" step="0.01" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      </div>
      <input type="number" id="itemQuantity" placeholder="Menge" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      <textarea id="itemImages" placeholder="Bild-URLs (durch Komma getrennt)" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <textarea id="itemDescription" placeholder="Artikelbeschreibung" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <button type="submit" class="w-full mt-6 p-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">Artikel posten</button>
    </form>

    <h2 class="text-3xl font-bold text-gray-700 mt-8 mb-4 text-center">Aktuelle Angebote</h2>
    <div id="itemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Artikel werden hier dynamisch eingefügt -->
    </div>

    <h2 class="text-3xl font-bold text-gray-700 mt-12 mb-4 text-center">Deine Kauf- und Verkaufshistorie</h2>
    <div id="historyContainer" class="bg-gray-50 p-4 rounded-xl shadow-inner">
      <!-- Kauf- und Verkaufshistorie wird hier angezeigt -->
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyCxq5QQU-H-gjbzaDqveRZOh6-dI452wuI",
      authDomain: "website-market-2a947.firebaseapp.com",
      projectId: "website-market-2a947",
      storageBucket: "website-market-2a947.firebasestorage.app",
      messagingSenderId: "314261738277",
      appId: "1:314261738277:web:a50c116a423d63455300cc"
    };

    const appId = "mein-marktplatz";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const addItemForm = document.getElementById("addItemForm");
    const itemsContainer = document.getElementById("itemsContainer");
    const currentUserIdSpan = document.getElementById("currentUserId");
    const currentBalanceSpan = document.getElementById("currentBalance");
    const historyContainer = document.getElementById("historyContainer");

    let userId;
    let userBalance = 0;

    async function authenticate() {
      try {
        await signInAnonymously(auth);
        userId = auth.currentUser.uid;
        currentUserIdSpan.textContent = userId;
        listenForUserBalance();
        listenForItems();
        listenForHistory();
      } catch (error) {
        alert("Fehler bei der Anmeldung: " + error.message);
      }
    }

    const listenForUserBalance = () => {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
      onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          userBalance = docSnap.data().balance;
        } else {
          userBalance = 1000;
          setDoc(userDocRef, { balance: userBalance });
        }
        currentBalanceSpan.textContent = userBalance.toFixed(2);
      });
    };

    const listenForItems = () => {
      const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
      onSnapshot(itemsCollectionRef, (querySnapshot) => {
        itemsContainer.innerHTML = '';
        querySnapshot.forEach((docSnap) => {
          const item = { id: docSnap.id, ...docSnap.data() };
          renderItem(item);
        });
      });
    };

    const renderItem = (item) => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-xl shadow-md p-4 cursor-pointer hover:shadow-lg transition-shadow";
      card.innerHTML = `
        <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-full h-48 object-cover rounded-md mb-4">
        <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
        <p class="text-green-600 text-lg font-semibold">${item.price.toFixed(2)} €</p>
        <p class="text-sm text-gray-600 mb-2 truncate">${item.description}</p>
        <p class="text-xs text-gray-400">Verkäufer: ${item.sellerId}</p>
        <p class="text-xs text-gray-500">Menge: ${item.quantity}</p>
      `;
      card.addEventListener("click", () => showItemDetails(item));
      itemsContainer.appendChild(card);
    };

    async function showItemDetails(item) {
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50";

      const imagesHtml = item.imageUrls.map(url => `<img src="${url}" alt="${item.name}">`).join('');

      let deleteButtonHtml = '';
      if(item.sellerId === userId) {
        deleteButtonHtml = `<button id="deleteItemBtn" class="mt-4 w-full px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Angebot löschen</button>`;
      }

      modal.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-lg w-full relative">
          <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
          <div class="image-carousel mb-4">${imagesHtml}</div>
          <h2 class="text-2xl font-bold mb-2">${item.name}</h2>
          <p class="text-green-600 text-lg font-semibold mb-2">${item.price.toFixed(2)} €</p>
          <p class="mb-4">${item.description}</p>
          <p class="text-sm text-gray-500 mb-4">Verkäufer: ${item.sellerId}</p>
          <p class="text-sm text-gray-500 mb-6">Verfügbar: ${item.quantity} Stück</p>
          <button id="buyItemBtn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Kaufen</button>
          ${deleteButtonHtml}
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector("#closeModal").addEventListener("click", () => modal.remove());

      modal.querySelector("#buyItemBtn").addEventListener("click", async () => {
        await buyItem(item);
        modal.remove();
      });

      if(item.sellerId === userId){
        modal.querySelector("#deleteItemBtn").addEventListener("click", async () => {
          await deleteDoc(doc(db, `artifacts/${appId}/public/data/products/${item.id}`));
          modal.remove();
        });
      }
    }

    async function buyItem(item) {
      if (item.price > userBalance) {
        alert("Nicht genug Guthaben!");
        return;
      }
      if (item.quantity <= 0) {
        alert("Artikel nicht mehr verfügbar!");
        return;
      }

      try {
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
        await updateDoc(itemRef, { quantity: item.quantity - 1 });

        // Käufer Guthaben reduzieren
        const buyerDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
        await updateDoc(buyerDocRef, { balance: userBalance - item.price });

        // Verkäufer Guthaben erhöhen
        const sellerBalanceRef = doc(db, `artifacts/${appId}/users/${item.sellerId}/profile/balance`);
        const sellerSnap = await getDoc(sellerBalanceRef);
        if (sellerSnap.exists()) {
          await updateDoc(sellerBalanceRef, { balance: sellerSnap.data().balance + item.price });
        } else {
          await setDoc(sellerBalanceRef, { balance: item.price });
        }

        // Kaufhistorie speichern
        const purchaseHistoryRef = collection(db, `artifacts/${appId}/users/${userId}/purchases`);
        await addDoc(purchaseHistoryRef, {
          itemId: item.id,
          name: item.name,
          price: item.price,
          sellerId: item.sellerId,
          timestamp: Date.now()
        });

        // Verkaufshistorie speichern
        const sellerHistoryRef = collection(db, `artifacts/${appId}/users/${item.sellerId}/sales`);
        await addDoc(sellerHistoryRef, {
          itemId: item.id,
          name: item.name,
          price: item.price,
          buyerId: userId,
          timestamp: Date.now()
        });

        alert("Kauf erfolgreich!");
      } catch (err) {
        console.error(err);
        alert("Fehler beim Kauf.");
      }
    }

    addItemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("itemName").value;
      const price = parseFloat(document.getElementById("itemPrice").value);
      const quantity = parseInt(document.getElementById("itemQuantity").value);
      const imageUrls = document.getElementById("itemImages").value.split(",").map(url => url.trim());
      const description = document.getElementById("itemDescription").value;

      const item = {
        name,
        price,
        quantity,
        imageUrls,
        description,
        sellerId: userId,
        timestamp: Date.now()
      };

      try {
        const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
        await addDoc(itemsCollectionRef, item);
        addItemForm.reset();
        alert("Artikel erfolgreich gepostet!");
      } catch (err) {
        console.error(err);
        alert("Fehler beim Posten des Artikels.");
      }
    });

    const listenForHistory = async () => {
      const purchasesRef = collection(db, `artifacts/${appId}/users/${userId}/purchases`);
      const salesRef = collection(db, `artifacts/${appId}/users/${userId}/sales`);

      onSnapshot(purchasesRef, async (purchasesSnap) => {
        const salesSnap = await getDocs(salesRef);
        renderHistory(purchasesSnap.docs.map(d => d.data()), salesSnap.docs.map(d => d.data()));
      });

      onSnapshot(salesRef, async (salesSnap) => {
        const purchasesSnap = await getDocs(purchasesRef);
        renderHistory(purchasesSnap.docs.map(d => d.data()), salesSnap.docs.map(d => d.data()));
      });
    };

    const renderHistory = (purchases, sales) => {
      let html = '<h3 class="font-bold mb-2">Gekauft:</h3>';
      if(purchases.length === 0) html += '<p class="mb-4 text-gray-500">Keine Käufe</p>';
      else html += purchases.map(p => `<p>${p.name} - ${p.price.toFixed(2)} € von ${p.sellerId}</p>`).join('');

      html += '<h3 class="font-bold mt-4 mb-2">Verkauft:</h3>';
      if(sales.length === 0) html += '<p class="mb-4 text-gray-500">Keine Verkäufe</p>';
      else html += sales.map(s => `<p>${s.name} - ${s.price.toFixed(2)} € an ${s.buyerId}</p>`).join('');

      historyContainer.innerHTML = html;
    };

    authenticate();
  </script>
</body>
</html>
