<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mein Online-Marktplatz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .container {
      max-width: 1200px;
    }
    .clickable-card {
      cursor: pointer;
    }
    .image-carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 8px;
    }
    .image-carousel img {
      flex: 0 0 auto;
      width: 100%;
      max-width: 100%;
      height: 300px;
      object-fit: cover;
      border-radius: 8px;
      scroll-snap-align: start;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

  <!-- Nachrichtenleiste -->
  <div id="messageBar" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0"></div>

  <div class="container mx-auto p-6 bg-white rounded-xl shadow-lg">
    <h1 class="text-4xl md:text-5xl font-extrabold text-center text-gray-800 mb-2">Mein Online-Marktplatz</h1>
    <p class="text-center text-gray-500 mb-6 md:text-lg">Biete Artikel an und finde tolle Angebote!</p>

    <div id="userInfo" class="flex flex-col md:flex-row justify-center items-center gap-4 text-sm text-gray-600 mb-6 p-2 bg-gray-200 rounded-lg">
      <p>Deine Nutzer-ID: <span id="currentUserId" class="font-mono font-bold text-blue-700"></span></p>
      <p>Dein Guthaben: <span id="currentBalance" class="font-bold text-green-600"></span> J€</p>
      <p id="adminStatus" class="text-red-600 font-bold hidden">[ADMIN-MODUS]</p>
    </div>

    <!-- Admin-Guthabenkontrolle -->
    <div id="adminBalanceControl" class="hidden mt-4 p-4 bg-yellow-50 rounded-lg shadow-inner">
      <h3 class="text-lg font-bold mb-2 text-gray-700">Guthaben eines Nutzers ändern</h3>
      <input type="text" id="targetUserId" placeholder="Nutzer-ID" class="w-full p-2 mb-2 rounded border border-gray-300">
      <input type="number" id="newBalance" placeholder="Neues Guthaben (J€)" step="0.01" class="w-full p-2 mb-2 rounded border border-gray-300">
      <button id="updateBalanceBtn" class="w-full p-2 bg-green-500 text-white font-bold rounded hover:bg-green-600">Guthaben ändern</button>
    </div>

    <button id="myTransactionsBtn" class="mt-4 p-2 bg-purple-600 text-white font-bold rounded hover:bg-purple-700 transition">Meine Transaktionen</button>

    <form id="addItemForm" class="bg-blue-50 p-6 rounded-xl shadow-inner mb-8">
      <h2 class="text-2xl font-bold text-gray-700 mb-4">Artikel anbieten</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="text" id="itemName" placeholder="Artikelbezeichnung" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
        <input type="number" id="itemPrice" placeholder="Preis in J€ (z.B. 9.99)" step="0.01" min="0" required class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      </div>
      <input type="number" id="itemQuantity" placeholder="Menge" min="0" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
      <textarea id="itemImages" placeholder="Bild-URLs (durch Komma getrennt)" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <textarea id="itemDescription" placeholder="Artikelbeschreibung" required class="w-full mt-4 p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors h-24 resize-none"></textarea>
      <button type="submit" class="w-full mt-6 p-4 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-md">Artikel posten</button>
    </form>

    <h2 class="text-3xl font-bold text-gray-700 mt-8 mb-4 text-center">Aktuelle Angebote</h2>
    <div id="itemsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Artikel werden hier dynamisch eingefügt -->
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, onSnapshot, collection, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyCxq5QQU-H-gjbzaDqveRZOh6-dI452wuI",
      authDomain: "website-market-2a947.firebaseapp.com",
      projectId: "website-market-2a947",
      storageBucket: "website-market-2a947.firebasestorage.app",
      messagingSenderId: "314261738277",
      appId: "1:314261738277:web:a50c116a423d63455300cc"
    };

    const appId = "mein-marktplatz";
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const addItemForm = document.getElementById("addItemForm");
    const itemsContainer = document.getElementById("itemsContainer");
    const currentUserIdSpan = document.getElementById("currentUserId");
    const currentBalanceSpan = document.getElementById("currentBalance");
    const messageBar = document.getElementById("messageBar");
    const adminStatus = document.getElementById("adminStatus");
    const adminBalanceControl = document.getElementById("adminBalanceControl");
    const updateBalanceBtn = document.getElementById("updateBalanceBtn");
    const myTransactionsBtn = document.getElementById("myTransactionsBtn");

    let userId;
    let userBalance = 0;
    let isAdmin = false;

    function showMessage(msg, type = 'success') {
      messageBar.textContent = msg;
      messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-100 opacity-100 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
      setTimeout(() => {
        messageBar.className = `fixed top-0 left-1/2 -translate-x-1/2 z-50 mt-4 p-4 rounded-lg text-white font-bold text-center transition-all duration-300 transform scale-0 opacity-0`;
      }, 3000);
    }

    function toggleAdminMode(enable) {
      isAdmin = enable;
      adminStatus.classList.toggle("hidden", !isAdmin);
      adminBalanceControl.classList.toggle("hidden", !isAdmin);
      showMessage(isAdmin ? "Admin-Modus aktiviert!" : "Admin-Modus deaktiviert!", isAdmin ? 'success' : 'error');
    }

    async function authenticate() {
      try {
        await signInAnonymously(auth);
        userId = auth.currentUser.uid;
        currentUserIdSpan.textContent = userId;
        listenForUserBalance();
        listenForItems();
      } catch (error) {
        showMessage("Fehler bei der Anmeldung: " + error.message, 'error');
      }
    }

    const listenForUserBalance = () => {
      const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
      onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
          userBalance = docSnap.data().balance;
        } else {
          userBalance = 1000;
          setDoc(userDocRef, { balance: userBalance });
        }
        currentBalanceSpan.textContent = userBalance.toFixed(2);
      });
    };

    const listenForItems = () => {
      const itemsCollectionRef = collection(db, `artifacts/${appId}/public/data/products`);
      onSnapshot(itemsCollectionRef, (querySnapshot) => {
        itemsContainer.innerHTML = '';
        querySnapshot.forEach((docSnap) => {
          const item = { id: docSnap.id, ...docSnap.data() };
          renderItem(item);
        });
      });
    };

    const renderItem = (item) => {
      const card = document.createElement("div");
      card.className = "bg-white rounded-xl shadow-md p-4 hover:shadow-lg transition-shadow relative";
      card.innerHTML = `
        <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-full h-48 object-cover rounded-md mb-4">
        <h3 class="text-xl font-bold text-gray-800">${item.name}</h3>
        <p class="text-green-600 text-lg font-semibold">${item.price.toFixed(2)} J€</p>
        <p class="text-sm text-gray-600 mb-2 truncate">${item.description}</p>
        <p class="text-xs text-gray-400">Verkäufer: ${item.sellerId}</p>
        <p class="text-xs text-gray-500">Menge: ${item.quantity}</p>
      `;

      if (item.sellerId === userId || isAdmin) {
        const deleteButton = document.createElement("button");
        deleteButton.className = "absolute top-2 right-2 p-2 bg-red-500 text-white rounded-full shadow-md hover:bg-red-600 transition-colors";
        deleteButton.innerHTML = `✖`;
        deleteButton.title = "Anzeige löschen";
        deleteButton.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
            deleteItem(item.id);
          }
        });

        const editButton = document.createElement("button");
        editButton.className = "absolute top-2 right-12 p-2 bg-yellow-500 text-white rounded-full shadow-md hover:bg-yellow-600 transition-colors";
        editButton.innerHTML = "✏️";
        editButton.title = "Anzeige bearbeiten";
        editButton.addEventListener("click", (e) => {
          e.stopPropagation();
          editItem(item);
        });

        card.appendChild(deleteButton);
        card.appendChild(editButton);
      }

      card.addEventListener("click", () => showItemDetails(item));
      itemsContainer.appendChild(card);
    };

    function showItemDetails(item) {
      const modal = document.createElement("div");
      modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center p-4 z-50";

      const imagesHtml = item.imageUrls.map(url => `<img src="${url}" alt="${item.name}" class="mb-2 w-full h-48 object-cover rounded">`).join('');

      modal.innerHTML = `
        <div class="bg-white p-6 rounded-xl max-w-lg w-full relative">
          <button id="closeModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
          <div class="image-carousel mb-4">${imagesHtml}</div>
          <h2 class="text-2xl font-bold mb-2">${item.name}</h2>
          <p class="text-green-600 text-lg font-semibold mb-2">${item.price.toFixed(2)} J€</p>
          <p class="mb-4">${item.description}</p>
          <p class="text-sm text-gray-500 mb-4">Verkäufer: ${item.sellerId}</p>
          <p class="text-sm text-gray-500 mb-6">Verfügbar: ${item.quantity} Stück</p>
          <button id="buyItemBtn" class="w-full px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Kaufen</button>
          ${(item.sellerId === userId || isAdmin) ? `
            <button id="editItemBtn" class="w-full mt-2 px-4 py-3 bg-yellow-500 text-white rounded-lg font-bold hover:bg-yellow-600 transition">Bearbeiten</button>
            <button id="deleteItemBtn" class="w-full mt-2 px-4 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition">Löschen</button>` : ''}
        </div>
      `;

      document.body.appendChild(modal);

      modal.querySelector("#closeModal").addEventListener("click", () => modal.remove());
      modal.querySelector("#buyItemBtn").addEventListener("click", async () => {
        await buyItem(item);
        modal.remove();
      });

      if (item.sellerId === userId || isAdmin) {
        modal.querySelector("#deleteItemBtn").addEventListener("click", () => {
          if (confirm("Möchten Sie diesen Artikel wirklich löschen?")) {
            deleteItem(item.id);
            modal.remove();
          }
        });
        modal.querySelector("#editItemBtn").addEventListener("click", () => {
          modal.remove();
          editItem(item);
        });
      }
    }

    async function editItem(item) {
      const newName = prompt("Neuer Name:", item.name);
      if (newName === null) return;
      const newPrice = parseFloat(prompt("Neuer Preis:", item.price));
      if (isNaN(newPrice) || newPrice < 0) { showMessage("Ungültiger Preis!", "error"); return; }
      const newQuantity = parseInt(prompt("Neue Menge:", item.quantity));
      if (isNaN(newQuantity) || newQuantity < 0) { showMessage("Ungültige Menge!", "error"); return; }
      const newDesc = prompt("Neue Beschreibung:", item.description);
      if (newDesc === null) return;

      try {
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);
        await updateDoc(itemRef, {
          name: newName,
          price: newPrice,
          quantity: newQuantity,
          description: newDesc
        });
        showMessage("Artikel erfolgreich bearbeitet!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Bearbeiten des Artikels.", 'error');
      }
    }

    async function deleteItem(itemId) {
      try {
        const itemRef = doc(db, `artifacts/${appId}/public/data/products/${itemId}`);
        await deleteDoc(itemRef);
        showMessage("Artikel erfolgreich gelöscht!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Löschen des Artikels.", 'error');
      }
    }

    async function buyItem(item) {
  if (item.price > userBalance) {
    showMessage("Nicht genug Guthaben!", 'error');
    return;
  }
  if (item.quantity <= 0) {
    showMessage("Artikel nicht mehr verfügbar!", 'error');
    return;
  }

  try {
    const itemRef = doc(db, `artifacts/${appId}/public/data/products/${item.id}`);

    // Atomare Transaktion für Menge und Käufer-Subcollection
    await updateDoc(itemRef, { quantity: item.quantity - 1 });

    // Neue Transaktion speichern
    const transaction = {
      buyerId: userId,
      quantity: 1,
      price: item.price,
      soldAt: Date.now()
    };
    await addDoc(collection(db, `artifacts/${appId}/public/data/products/${item.id}/transactions`), transaction);

    // Guthaben Käufer aktualisieren
    const buyerDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/balance`);
    await updateDoc(buyerDocRef, { balance: userBalance - item.price });

    // Guthaben Verkäufer aktualisieren
    const sellerBalanceRef = doc(db, `artifacts/${appId}/users/${item.sellerId}/profile/balance`);
    const sellerSnap = await getDoc(sellerBalanceRef);
    if (sellerSnap.exists()) {
      await updateDoc(sellerBalanceRef, { balance: sellerSnap.data().balance + item.price });
    } else {
      await setDoc(sellerBalanceRef, { balance: item.price });
    }

    showMessage("Kauf erfolgreich!", 'success');
  } catch (err) {
    console.error(err);
    showMessage("Fehler beim Kauf.", 'error');
  }
}

    addItemForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = document.getElementById("itemName").value;

      if (name === "ADMIN_J123") {
        toggleAdminMode(true);
        addItemForm.reset();
        return;
      }
      if (name === "ADMIN_D123") {
        toggleAdminMode(false);
        addItemForm.reset();
        return;
      }

      const price = parseFloat(document.getElementById("itemPrice").value);
      const quantity = parseInt(document.getElementById("itemQuantity").value);
      const imageUrls = document.getElementById("itemImages").value.split(",").map(url => url.trim());
      const description = document.getElementById("itemDescription").value;

      if (price < 0 || quantity < 0) {
        showMessage("Preis und Menge dürfen nicht negativ sein!", "error");
        return;
      }

      const item = {
        name,
        price,
        quantity,
        imageUrls,
        description,
        sellerId: userId,
        timestamp: Date.now()
      };

      try {
        await addDoc(collection(db, `artifacts/${appId}/public/data/products`), item);
        addItemForm.reset();
        showMessage("Artikel erfolgreich hinzugefügt!", 'success');
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Hinzufügen des Artikels.", 'error');
      }
    });

    // Admin: Guthaben ändern
    updateBalanceBtn.addEventListener("click", async () => {
      const targetId = document.getElementById("targetUserId").value.trim();
      const newBal = parseFloat(document.getElementById("newBalance").value);

      if (!targetId || isNaN(newBal) || newBal < 0) {
        showMessage("Bitte gültige Nutzer-ID und Guthaben eingeben!", "error");
        return;
      }

      try {
        const targetRef = doc(db, `artifacts/${appId}/users/${targetId}/profile/balance`);
        await setDoc(targetRef, { balance: newBal }, { merge: true });
        showMessage(`Guthaben von Nutzer ${targetId} auf ${newBal.toFixed(2)} J€ gesetzt!`, "success");
      } catch (err) {
        console.error(err);
        showMessage("Fehler beim Ändern des Guthabens.", "error");
      }
    });

    // Transaktionen anzeigen
    myTransactionsBtn.addEventListener("click", async () => {
  const modal = document.createElement("div");
  modal.className = "fixed inset-0 bg-black bg-opacity-50 flex justify-center items-start p-4 z-50 overflow-auto";

  modal.innerHTML = `
    <div class="bg-white p-6 rounded-xl max-w-3xl w-full relative mt-10">
      <button id="closeTransactionsModal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800 text-xl font-bold">&times;</button>
      <h2 class="text-2xl font-bold mb-4">Meine Transaktionen</h2>
      <div id="transactionsContent" class="grid gap-4"></div>
    </div>
  `;

  document.body.appendChild(modal);
  modal.querySelector("#closeTransactionsModal").addEventListener("click", () => modal.remove());

  const transactionsContent = modal.querySelector("#transactionsContent");

  try {
    const productsCol = collection(db, `artifacts/${appId}/public/data/products`);
    const snapshot = await getDocs(productsCol);

    transactionsContent.innerHTML = "";

    for (const docSnap of snapshot.docs) {
      const item = { id: docSnap.id, ...docSnap.data() };
      const transCol = collection(db, `artifacts/${appId}/public/data/products/${item.id}/transactions`);
      const transSnapshot = await getDocs(transCol);

      // Verkäufe
      transSnapshot.forEach(t => {
        const trans = t.data();
        if (item.sellerId === userId) {
          const soldCard = document.createElement("div");
          soldCard.className = "p-3 border rounded bg-green-50 flex gap-4";
          soldCard.innerHTML = `
            <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
            <div>
              <strong>Verkauft:</strong> ${item.name} <br>
              Preis: ${trans.price.toFixed(2)} J€ <br>
              An: ${trans.buyerId} <br>
              Menge: ${trans.quantity} <br>
              Datum: ${new Date(trans.soldAt).toLocaleString()}
            </div>
          `;
          transactionsContent.appendChild(soldCard);
        }

        // Käufe
        if (trans.buyerId === userId) {
          const boughtCard = document.createElement("div");
          boughtCard.className = "p-3 border rounded bg-blue-50 flex gap-4";
          boughtCard.innerHTML = `
            <img src="${item.imageUrls[0]}" alt="${item.name}" class="w-20 h-20 object-cover rounded">
            <div>
              <strong>Gekauft:</strong> ${item.name} <br>
              Preis: ${trans.price.toFixed(2)} J€ <br>
              Von: ${item.sellerId} <br>
              Menge: ${trans.quantity} <br>
              Datum: ${new Date(trans.soldAt).toLocaleString()}
            </div>
          `;
          transactionsContent.appendChild(boughtCard);
        }
      });
    }

    if (transactionsContent.innerHTML === "") {
      transactionsContent.innerHTML = "<p class='text-gray-500'>Keine Transaktionen gefunden.</p>";
    }
  } catch (err) {
    console.error(err);
    showMessage("Fehler beim Laden der Transaktionen.", "error");
  }
});

    authenticate();
  </script>
  <!-- ===== ACHIEVEMENTS & MINI AD-APP (INSERT BEFORE </body>) ===== -->
<style>
  /* Tab bar */
  #mini-tabbar { position: fixed; right: 18px; top: 18px; z-index: 9999; display:flex; gap:6px; }
  .mini-tab-btn { background:#0366d6;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;box-shadow:0 2px 6px rgba(0,0,0,.15); }
  .mini-tab-btn.inactive { background:#e7eefb;color:#0366d6;border:1px solid #c6ddfb;font-weight:600; }
  /* Wrapper */
  #__app_wrapper { transition: all .18s ease; padding-top: 60px; }
  /* Achievements panel */
  #achievements-panel { display:none; max-width:980px; margin:24px auto; background:#fff;border-radius:10px;padding:18px; box-shadow: 0 6px 18px rgba(0,0,0,.08); }
  #achievements-panel h2{margin-top:0}
  .task { border:1px solid #eee;padding:12px;border-radius:8px;margin-bottom:10px; display:flex; gap:12px; align-items:center; }
  .task .meta { flex:1 }
  .task .title { font-weight:700 }
  .progress-bar { height:10px;background:#f1f5f9;border-radius:6px;overflow:hidden;margin-top:8px; }
  .progress-bar > i { display:block;height:100%;background:linear-gradient(90deg,#34d399,#60a5fa); width:0%; }
  .task .reward { white-space:nowrap;padding:6px 10px;background:#f8fafc;border-radius:6px;border:1px solid #e6eef9; font-weight:700 }
  .ads-panel { margin-top:16px; display:grid; grid-template-columns: 1fr 360px; gap:18px; align-items:start; }
  .ad-list { max-height:420px; overflow:auto; border:1px dashed #e6eef9;padding:10px;border-radius:8px; }
  .ad-item { padding:8px;border-radius:6px;border-bottom:1px solid #f0f3f7; display:flex; gap:8px; align-items:center; }
  .ad-item img{width:56px;height:42px;object-fit:cover;border-radius:6px}
  .ad-actions button{ margin-left:6px }
  .small { font-size:0.85rem;color:#6b7280 }
</style>

<!-- Tab buttons -->
<div id="mini-tabbar" aria-hidden="false">
  <button id="btn-app" class="mini-tab-btn inactive" title="Return to page">App</button>
  <button id="btn-achievements" class="mini-tab-btn" title="Open Achievements">Achievements</button>
</div>

<!-- Container wrapper (wraps existing content on runtime) -->
<div id="__app_wrapper"></div>

<!-- Achievements panel -->
<div id="achievements-panel" aria-live="polite">
  <h2>Aufgaben & Achievements</h2>
  <p class="small">Erledige Aufgaben, indem du Anzeigen erstellst / bearbeitest / löscht / ansiehst / favorisierst. Alles lokal gespeichert.</p>

  <div class="ads-panel">
    <!-- left: tasks list -->
    <div id="tasks-list">
      <!-- JS füllt die Aufgaben (>=30) -->
    </div>

    <!-- right: mini ad creator & ad list -->
    <div>
      <div style="border:1px solid #e6eef9;padding:12px;border-radius:8px;">
        <h3 style="margin:0 0 8px 0">Schnell-Anzeige erstellen</h3>
        <form id="ad-form">
          <div style="display:flex;flex-direction:column;gap:8px">
            <input id="ad-title" placeholder="Titel" required />
            <textarea id="ad-desc" placeholder="Beschreibung" rows="4"></textarea>
            <input id="ad-price" placeholder="Preis (z.B. 200)" type="number" />
            <input id="ad-tags" placeholder="Tags (kommagetrennt)" />
            <input id="ad-location" placeholder="Ort" />
            <input id="ad-phone" placeholder="Telefon (optional)" />
            <input id="ad-images" type="file" accept="image/*" multiple />
            <div style="display:flex;gap:8px">
              <button type="submit" class="mini-tab-btn">Posten</button>
              <button type="button" id="clear-ads" class="mini-tab-btn inactive">Alle Anzeigen löschen</button>
            </div>
            <div class="small">Hinweis: Bilder werden lokal als Data-URLs gespeichert.</div>
          </div>
        </form>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin:6px 0">Deine Anzeigen</h4>
        <div class="ad-list" id="ad-list"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // --- Utilities & persistence ---
  const $ = (s, root=document)=>root.querySelector(s);
  const $$ = (s, root=document)=>Array.from(root.querySelectorAll(s));
  const STORAGE_KEY = 'mini_ads_app_v1';

  function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}') }catch(e){return{}} }
  function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }
  function ensureState(){ let st=loadState(); st.ads = st.ads || []; st.meta = st.meta || {}; saveState(st); return st; }

  // --- Wrap existing page content into app wrapper so we can toggle views ---
  document.addEventListener('DOMContentLoaded', ()=>{
    const wrapper = document.getElementById('__app_wrapper');
    // move existing <main> or body children into our wrapper
    const main = document.querySelector('main') || document.body;
    // If main already inside wrapper, skip
    if(!wrapper.contains(main)){
      // create container and move main to wrapper
      const container = document.createElement('div');
      container.id = 'page-main-content';
      // move children of main into container
      if(main.parentElement){
        main.parentElement.insertBefore(container, main);
        container.appendChild(main);
      } else {
        // fallback: move body children
        while(document.body.firstChild) container.appendChild(document.body.firstChild);
        document.body.appendChild(container);
      }
      wrapper.appendChild(container);
    }

    setupTabs();
    initApp();
  });

  // --- Tabs ---
  function setupTabs(){
    const btnApp = document.getElementById('btn-app');
    const btnAch = document.getElementById('btn-achievements');
    const achievements = document.getElementById('achievements-panel');
    const pageMain = document.getElementById('page-main-content');

    btnApp.addEventListener('click', ()=>{ showMain(); });
    btnAch.addEventListener('click', ()=>{ showAchievements(); });

    function showAchievements(){
      pageMain.style.display = 'none';
      achievements.style.display = 'block';
      btnAch.classList.remove('inactive'); btnApp.classList.add('inactive');
      window.scrollTo({top:0, behavior:'smooth'});
    }
    function showMain(){
      pageMain.style.display = '';
      achievements.style.display = 'none';
      btnApp.classList.remove('inactive'); btnAch.classList.add('inactive');
    }

    // default: keep main visible and achievements hidden
    showMain();
  }

  // --- App logic (ads + tasks) ---
  const TASKS = generateTasks(); // array of task definitions

  function generateTasks(){
    // Task types:
    // 1) post X ads (1,3,5,10,20) -> 5 tasks
    // 2) ad with >= images (1,2,3,5) -> 4 tasks
    // 3) ad price >= thresholds (100,500,1000) ->3
    // 4) description length >= (50,200) ->2
    // 5) edit N ads (1,5) ->2
    // 6) delete N ads (1,3) ->2
    // 7) favorite N ads (1,10) ->2
    // 8) view N unique ads (5,20) ->2
    // 9) tags count (1 tag, 3 tags) ->2
    //10) share ads (1,10) ->2
    //11) title length (>=10, >=30) ->2
    //12) set location (1) ->1
    //13) add phone (1) ->1
    // Total >=30
    const arr = [];
    let id = 1;
    function t(type, goal, reward, desc){ arr.push({id: 't'+(id++), type, goal, reward, desc}); }
    // 1
    t('post_count', 1, 10, 'Poste 1 Anzeige');
    t('post_count', 3, 30, 'Poste 3 Anzeigen');
    t('post_count', 5, 70, 'Poste 5 Anzeigen');
    t('post_count', 10, 200, 'Poste 10 Anzeigen');
    t('post_count', 20, 500, 'Poste 20 Anzeigen');
    // 2 images
    t('images_in_ad', 1, 5, 'Poste eine Anzeige mit mindestens 1 Bild');
    t('images_in_ad', 2, 20, 'Poste eine Anzeige mit mindestens 2 Bildern');
    t('images_in_ad', 3, 50, 'Poste eine Anzeige mit mindestens 3 Bildern');
    t('images_in_ad', 5, 120, 'Poste eine Anzeige mit mindestens 5 Bildern');
    // 3 price
    t('price_threshold', 100, 10, 'Poste eine Anzeige mit Preis ≥ 100€');
    t('price_threshold', 500, 40, 'Poste eine Anzeige mit Preis ≥ 500€');
    t('price_threshold', 1000, 100, 'Poste eine Anzeige mit Preis ≥ 1000€');
    // 4 description length
    t('desc_length', 50, 5, 'Poste eine Anzeige mit Beschreibung ≥ 50 Zeichen');
    t('desc_length', 200, 20, 'Poste eine Anzeige mit Beschreibung ≥ 200 Zeichen');
    // 5 edits
    t('edit_count', 1, 10, 'Bearbeite 1 Anzeige');
    t('edit_count', 5, 40, 'Bearbeite 5 Anzeigen');
    // 6 deletes
    t('delete_count', 1, 5, 'Lösche 1 Anzeige');
    t('delete_count', 3, 20, 'Lösche 3 Anzeigen');
    // 7 favorites
    t('fav_count', 1, 5, 'Markiere 1 Anzeige als Favorit');
    t('fav_count', 10, 50, 'Markiere 10 Anzeigen als Favorit');
    // 8 views
    t('view_unique', 5, 5, 'Siehe 5 verschiedene Anzeigen an');
    t('view_unique', 20, 20, 'Siehe 20 verschiedene Anzeigen an');
    // 9 tags
    t('tags_count', 1, 5, 'Poste eine Anzeige mit mindestens 1 Tag');
    t('tags_count', 3, 20, 'Poste eine Anzeige mit mindestens 3 Tags');
    //10 share
    t('share_count', 1, 5, 'Teile 1 Anzeige (Share)');
    t('share_count', 10, 40, 'Teile 10 Anzeigen');
    //11 title length
    t('title_length', 10, 5, 'Poste eine Anzeige mit Titel ≥ 10 Zeichen');
    t('title_length', 30, 15, 'Poste eine Anzeige mit Titel ≥ 30 Zeichen');
    //12 location
    t('location_set', 1, 10, 'Poste eine Anzeige mit Ort/Location');
    //13 phone
    t('phone_set', 1, 10, 'Poste eine Anzeige mit Telefonnummer');
    return arr;
  }

  // --- Render tasks UI ---
  function renderTasks(){
    const container = document.getElementById('tasks-list');
    container.innerHTML = '';
    const st = ensureState();
    const stats = computeStats(st);
    TASKS.forEach(task=>{
      const dom = document.createElement('div');
      dom.className = 'task';
      const meta = document.createElement('div'); meta.className='meta';
      const title = document.createElement('div'); title.className='title'; title.textContent = task.desc;
      const small = document.createElement('div'); small.className='small'; small.textContent = `Typ: ${task.type} • Ziel: ${task.goal}`;
      const progWrap = document.createElement('div'); progWrap.className='progress-bar';
      const progBar = document.createElement('i');
      // compute progress value
      const val = taskProgress(task, stats);
      const percent = Math.min(100, Math.round((val / task.goal) * 100));
      progBar.style.width = percent + '%';
      progWrap.appendChild(progBar);
      meta.appendChild(title); meta.appendChild(small); meta.appendChild(progWrap);
      const rew = document.createElement('div'); rew.className='reward'; rew.textContent = `${task.reward}€`;
      dom.appendChild(meta); dom.appendChild(rew);
      // add textual progress
      const ptext = document.createElement('div'); ptext.className='small';
      ptext.style.marginLeft='12px';
      ptext.textContent = `${Math.min(val,task.goal)} / ${task.goal}`;
      meta.appendChild(ptext);

      container.appendChild(dom);
    });
  }

  // compute all derived stats from ads + meta interactions
  function computeStats(state){
    state = state || ensureState();
    const ads = state.ads || [];
    const meta = state.meta || {};
    // counts
    const totalPosts = ads.length;
    const imagesPerAdMax = ads.reduce((m,a)=>Math.max(m,(a.images||[]).length),0);
    const anyPriceOver = (threshold)=>ads.some(a=>parseFloat(a.price||0) >= threshold);
    const descLengthMax = ads.reduce((m,a)=>Math.max(m,(a.desc||'').length),0);
    const edits = meta.edit_count || 0;
    const deletes = meta.delete_count || 0;
    const favs = ads.filter(a=>a.fav).length;
    const uniqueViews = (meta.views || {}) ? Object.keys(meta.views).length : 0;
    const tagsMax = ads.reduce((m,a)=>Math.max(m,(a.tags||[]).length),0);
    const shares = meta.share_count || 0;
    const titleLenMax = ads.reduce((m,a)=>Math.max(m,(a.title||'').length),0);
    const locationCount = ads.filter(a=>a.location && a.location.trim()).length;
    const phoneCount = ads.filter(a=>a.phone && a.phone.trim()).length;

    return {
      ads, totalPosts, imagesPerAdMax, descLengthMax, edits, deletes, favs,
      uniqueViews, tagsMax, shares, titleLenMax, locationCount, phoneCount,
      anyPriceOverFunc: anyPriceOver
    };
  }

  // returns numeric progress corresponding to task type
  function taskProgress(task, stats){
    stats = stats || computeStats();
    switch(task.type){
      case 'post_count': return stats.totalPosts;
      case 'images_in_ad':
        // find best ad images count
        return Math.max(...(stats.ads.map(a=> (a.images||[]).length )), 0);
      case 'price_threshold':
        return stats.ads.filter(a=>parseFloat(a.price||0) >= task.goal).length; // number of ads meeting threshold
      case 'desc_length':
        return stats.ads.some(a=> (a.desc||'').length >= task.goal) ? task.goal : 0;
      case 'edit_count':
        return stats.edits || 0;
      case 'delete_count':
        return stats.deletes || 0;
      case 'fav_count':
        return stats.favs || 0;
      case 'view_unique':
        return stats.uniqueViews || 0;
      case 'tags_count':
        return stats.tagsMax || 0;
      case 'share_count':
        return stats.shares || 0;
      case 'title_length':
        return stats.titleLenMax || 0;
      case 'location_set':
        return stats.locationCount || 0;
      case 'phone_set':
        return stats.phoneCount || 0;
      default:
        return 0;
    }
  }

  // --- Ads UI & operations ---
  function initApp(){
    ensureState();
    renderTasks();
    renderAdList();

    // form events
    $('#ad-form').addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const title = $('#ad-title').value.trim();
      const desc = $('#ad-desc').value.trim();
      const price = $('#ad-price').value.trim();
      const tags = ($('#ad-tags').value || '').split(',').map(s=>s.trim()).filter(Boolean);
      const location = $('#ad-location').value.trim();
      const phone = $('#ad-phone').value.trim();
      const files = $('#ad-images').files;
      const images = await filesToDataURLs(files);
      createAd({title, desc, price, tags, images, location, phone});
      $('#ad-form').reset();
      renderAdList(); renderTasks();
      flash('Anzeige gepostet');
    });

    $('#clear-ads').addEventListener('click', ()=>{
      if(confirm('Alle lokal gespeicherten Anzeigen löschen?')){ const st=ensureState(); st.ads=[]; st.meta={}; saveState(st); renderAdList(); renderTasks(); flash('Alle Anzeigen gelöscht'); }
    });
  }

  function flash(msg){
    const el = document.createElement('div'); el.textContent = msg;
    el.style.position='fixed'; el.style.bottom='18px'; el.style.left='18px';
    el.style.background='#111'; el.style.color='#fff'; el.style.padding='8px 12px';
    el.style.borderRadius='6px'; el.style.zIndex = 99999; document.body.appendChild(el);
    setTimeout(()=>el.remove(), 2200);
  }

  function filesToDataURLs(fileList){
    return new Promise((res)=>{
      if(!fileList || fileList.length===0) return res([]);
      const promises = Array.from(fileList).map(file => new Promise((r)=>{
        const reader = new FileReader();
        reader.onload = ()=>r(reader.result);
        reader.readAsDataURL(file);
      }));
      Promise.all(promises).then(res);
    });
  }

  function createAd({title, desc, price, tags, images, location, phone}){
    const st = ensureState();
    const id = 'ad_' + Date.now() + '_' + Math.floor(Math.random()*9999);
    const ad = { id, title, desc, price, tags, images, location, phone, fav:false, created:Date.now() };
    st.ads.unshift(ad);
    saveState(st);
  }

  function renderAdList(){
    const st = ensureState();
    const list = $('#ad-list');
    list.innerHTML = '';
    st.ads.forEach(ad=>{
      const row = document.createElement('div'); row.className='ad-item';
      const thumb = document.createElement('img'); thumb.src = (ad.images && ad.images[0]) ? ad.images[0] : 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="80"><rect width="100%" height="100%" fill="#eef2ff"/></svg>');
      const info = document.createElement('div'); info.style.flex='1';
      info.innerHTML = `<div style="font-weight:700">${escapeHtml(ad.title||'—')}</div><div class="small">${escapeHtml(ad.location||'—')} • ${escapeHtml(ad.price||'—')}€</div>`;
      const actions = document.createElement('div'); actions.className='ad-actions';
      const viewBtn = document.createElement('button'); viewBtn.textContent='Ansehen'; viewBtn.className='mini-tab-btn inactive';
      const favBtn = document.createElement('button'); favBtn.textContent = ad.fav ? '★' : '☆'; favBtn.className='mini-tab-btn';
      const editBtn = document.createElement('button'); editBtn.textContent='Bearbeiten'; editBtn.className='mini-tab-btn inactive';
      const delBtn = document.createElement('button'); delBtn.textContent='Löschen'; delBtn.className='mini-tab-btn';
      const shareBtn = document.createElement('button'); shareBtn.textContent='Teilen'; shareBtn.className='mini-tab-btn inactive';

      viewBtn.addEventListener('click', ()=>{ openAdModal(ad.id); incrementView(ad.id); renderTasks(); });
      favBtn.addEventListener('click', ()=>{ toggleFav(ad.id); renderAdList(); renderTasks(); });
      editBtn.addEventListener('click', ()=>{ openEditPrompt(ad.id); });
      delBtn.addEventListener('click', ()=>{ deleteAd(ad.id); renderAdList(); renderTasks(); });
      shareBtn.addEventListener('click', ()=>{ shareAd(ad.id); renderTasks(); });

      actions.appendChild(viewBtn); actions.appendChild(favBtn); actions.appendChild(editBtn); actions.appendChild(shareBtn); actions.appendChild(delBtn);
      row.appendChild(thumb); row.appendChild(info); row.appendChild(actions);
      list.appendChild(row);
    });

    if(st.ads.length===0){
      list.innerHTML = '<div class="small">Noch keine Anzeigen. Erstelle eine rechts.</div>';
    }
  }

  function escapeHtml(s){ if(!s) return ''; return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function getState(){ return ensureState(); }

  function toggleFav(id){
    const st = ensureState();
    const ad = st.ads.find(a=>a.id===id);
    if(ad){ ad.fav = !ad.fav; saveState(st); flash(ad.fav ? 'Als Favorit markiert' : 'Favorit entfernt'); }
  }

  function openEditPrompt(id){
    const st = ensureState(); const ad = st.ads.find(a=>a.id===id);
    if(!ad) return;
    const newTitle = prompt('Titel bearbeiten', ad.title) || ad.title;
    const newDesc = prompt('Beschreibung bearbeiten', ad.desc) || ad.desc;
    ad.title = newTitle; ad.desc = newDesc;
    // increment edit count
    st.meta.edit_count = (st.meta.edit_count || 0) + 1;
    saveState(st);
    renderAdList(); renderTasks(); flash('Anzeige bearbeitet');
  }

  function deleteAd(id){
    const st = ensureState();
    const idx = st.ads.findIndex(a=>a.id===id);
    if(idx>=0){
      st.ads.splice(idx,1);
      st.meta.delete_count = (st.meta.delete_count || 0) + 1;
      saveState(st);
      flash('Anzeige gelöscht');
    }
  }

  function openAdModal(id){
    const st = ensureState(); const ad = st.ads.find(a=>a.id===id); if(!ad) return;
    // simple modal
    const modal = document.createElement('div'); modal.style.position='fixed'; modal.style.left=0; modal.style.top=0; modal.style.width='100%'; modal.style.height='100%'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex=999999;
    modal.style.background='rgba(0,0,0,0.4)';
    const card = document.createElement('div'); card.style.background='#fff'; card.style.padding='18px'; card.style.borderRadius='10px'; card.style.maxWidth='760px'; card.style.width='90%'; card.style.maxHeight='80%'; card.style.overflow='auto';
    card.innerHTML = `<h3>${escapeHtml(ad.title)}</h3><div class="small">${escapeHtml(ad.location||'—')} • ${escapeHtml(ad.price||'—')}€</div><p>${escapeHtml(ad.desc||'')}</p>`;
    if(ad.images && ad.images.length){
      const imgs = document.createElement('div'); imgs.style.display='flex'; imgs.style.gap='8px'; imgs.style.flexWrap='wrap';
      ad.images.forEach(src=>{ const i=document.createElement('img'); i.src=src; i.style.width='160px'; i.style.height='110px'; i.style.objectFit='cover'; i.style.borderRadius='6px'; imgs.appendChild(i); });
      card.appendChild(imgs);
    }
    const close = document.createElement('button'); close.textContent='Schließen'; close.className='mini-tab-btn inactive'; close.style.marginTop='12px';
    close.addEventListener('click', ()=>modal.remove());
    card.appendChild(close);
    modal.appendChild(card);
    document.body.appendChild(modal);
  }

  function incrementView(id){
    const st = ensureState();
    st.meta.views = st.meta.views || {};
    st.meta.views[id] = true; // unique views by id
    saveState(st);
  }

  function shareAd(id){
    const st = ensureState(); st.meta.share_count = (st.meta.share_count || 0) + 1; saveState(st);
    // simulated share: copy a fake url
    const fakeUrl = location.origin + location.pathname + '#ad=' + id;
    navigator.clipboard?.writeText(fakeUrl).then(()=>flash('Link kopiert (simuliert)'));
  }

  // Recompute & rerender periodically for reactivity
  setInterval(()=>{ renderTasks(); renderAdList(); }, 1000);

  // ensure initial render (in case state exists)
  document.addEventListener('DOMContentLoaded', ()=>{ renderTasks(); renderAdList(); });

})();
</script>
<!-- ===== END ACHIEVEMENTS ===== -->
</body>
</html>
